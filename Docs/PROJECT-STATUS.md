# Project Status

## Current Version: 0.5.0

## Phase Completion

| Phase | Description | Status | Notes |
|-------|-------------|--------|-------|
| 1 | Project setup + Swiss Ephemeris integration | Done | Vendored from github.com/aloistr/swisseph |
| 2 | Tithi calculation + sunrise | Done | Bisection-based boundary finding |
| 3 | Month (masa) determination | Done | Amanta scheme, adhika detection working |
| 4 | Full month panchang CLI | Done | Single-day and full-month views |
| 5 | Validation against drikpanchang.com | Done | 186 dates verified against drikpanchang.com |
| 6 | Validation web page | Done | Month-by-month visual comparison tool |
| 7 | Reingold diff overlay | Done | HL diffs shown on web page (89.2% match) |
| 8 | Hindu solar calendars | Done | Tamil, Bengali, Odia, Malayalam — all verified against drikpanchang.com |
| 9 | Self-contained Moshier ephemeris | Done | 1,265-line replacement for 51K-line Swiss Ephemeris |
| 10 | VSOP87 solar longitude upgrade | Done | ±1″ solar, all solar tests 100%, 120→29 total failures |

## Test Results

**With Swiss Ephemeris backend** (`make USE_SWISSEPH=1`): 53,143/53,143 assertions pass (100%).

**With Moshier backend** (default `make`): 53,114/53,143 assertions pass (99.95%). 29 failures are tithi boundary edge cases caused by ~10 arcsecond lunar longitude precision (Meeus Ch.47, 60-term ELP-2000/82). All solar calendar tests pass 100%.

53,143 assertions across 10 test suites:

| Suite | Assertions | What it tests |
|-------|------------|---------------|
| test_astro | 11 | JD conversion, day-of-week, solar longitude, ayanamsa, sunrise |
| test_tithi | 18 | Tithi at known dates, kshaya/adhika detection, lunar phase |
| test_masa | 24 | Month name, adhika months, solar rashi, Saka/Vikram years |
| test_validation | 744 | **External validation**: 186 dates verified against drikpanchang.com x 4 checks |
| test_csv_regression | 4,416 | **Regression**: 1,104 sampled days from generated CSV (1900-2050) x 4 checks |
| test_adhika_kshaya | 17,076 | **Regression**: all 4,269 adhika/kshaya tithi edge-case days (1900-2050) x 4 checks |
| test_solar | 351 | **Solar calendars**: dates across 4 regional variants + roundtrip + sankranti precision + month/era names + Odia/Malayalam boundary cases |
| test_solar_validation | 327 | **External validation**: month-start dates verified against drikpanchang.com/prokerala.com for all 4 solar calendars |
| test_solar_regression | 28,976 | **Regression**: 1,811 months x 4 calendars checked against generated CSVs (1900-2050) |
| test_solar_edge | 1,200 | **Edge cases**: 100 closest-to-critical-time sankrantis per calendar (400 total), 21 corrected from drikpanchang.com verification (Tamil/Malayalam), 23 Bengali entries updated for tithi-based rule |

## Validated Against drikpanchang.com

186 dates spanning 1900-2050 verified against drikpanchang.com day-panchang pages:

- **54 general dates** (1950-2045): hand-picked covering month boundaries, adhika months, year transitions
- **132 adhika/kshaya tithi edge-case dates** (1900-2050): batch-verified in 5 rounds, including 52 adhika tithi dates and 80 kshaya tithi dates
- Tithi at sunrise: 100% match (186/186)
- Month (masa) name: 100% match (186/186)
- Adhika month detection: 100% match (tested 1993, 2004, 2007, 2012, 2015, 2018, 2020, 2023, 2039, 2050)
- Saka year: 100% match (186/186)
- Sunrise time: within ~1 minute of drikpanchang.com (Moshier ephemeris vs Swiss files)

## Regression Tests

A 55,152-day CSV (`ref_1900_2050.csv`) was generated by our calculator for 1900-2050. Two regression test suites verify self-consistency against this CSV — they catch unintended changes from code modifications but are **not** independently validated against an external source. The 186 spot-checked dates above give confidence the underlying data is correct.

## Validation Web Page

A browser-based tool for manual month-by-month comparison against drikpanchang.com, covering all 1,812 months from 1900 to 2050.

- **Server**: `bash validation/web/serve.sh` → http://localhost:8082 (no-cache headers)
- **Layout**: Transposed calendar grid (rows = days of week, columns = weeks), matching drikpanchang.com
- **Reingold overlay**: Orange-highlighted cells where Reingold/Dershowitz (Surya Siddhanta, `hindu-lunar-from-fixed`) disagrees with our Drik Siddhanta calculation
  - 5,943 of 55,152 days differ (89.2% match rate)
  - Toggle on/off via "R/D overlay" checkbox in header
- **Data pipeline**: `python3 tools/csv_to_json.py` regenerates all JSON from `ref_1900_2050.csv` + `reingold_1900_2050.csv`

## Solar Calendar Validation

351 unit test assertions + 327 external validation assertions + 28,976 regression assertions + 1,200 edge case assertions across 4 regional solar calendar variants:

- **Tamil** (10 unit + 33 validation + 100 edge case dates): Sankranti boundaries, mid-month, year transitions, all 12 months of 2025, Chithirai 1 across 21 years (Saka era). Critical time adjusted by −8.0 min for ayanamsa difference; 6 boundary dates corrected
- **Bengali** (9 unit + 24 validation + 100 edge case dates): Midnight + 24min buffer with tithi-based rule (Sewell & Dikshit, 1896) for edge cases — Karkata always "before midnight", Makara always "after midnight", others check tithi at Hindu sunrise. 36/37 verified edge cases correct (1 known failure: 1976-10-17). Boishakh 1 across 12 years, all 12 months of 2025 (Bangabda era)
- **Odia** (7 unit + 24 validation + 100 edge case dates): Fixed 22:12 IST cutoff, all 12 months of 2025 + 2030 (Saka era). 100/100 edge cases correct — no ayanamsa adjustment needed
- **Malayalam** (7 unit + 28 validation + 100 edge case dates): End-of-madhyahna critical time, Chingam 1 across 16 years, all 12 months of 2025 (Kollam era). Critical time adjusted by −9.5 min for ayanamsa difference; 15 boundary dates corrected
- Roundtrip tests: `gregorian_to_solar()` → `solar_to_gregorian()` for all 33 unit test dates
- Sankranti precision: Mesha Sankranti 2025 longitude error < 0.0001°
- Month names and era names verified for all 4 calendars
- Malayalam madhyahna rule (3/5 of daytime) verified correct against prokerala.com for all 5 edge cases in 2025 where noon and midnight rules disagree
- Regression CSVs: 1,811 months per calendar (1900-2050), checked for month/year/day consistency

## Ayanamsa Buffer Adjustments

Swiss Ephemeris SE_SIDM_LAHIRI differs from drikpanchang.com's Lahiri ayanamsa by ~24 arcseconds. At the sun's typical speed (~1°/day), this translates to ~8–10 minutes offset in sankranti times. For dates where the sankranti falls close to the critical time, this offset can flip which civil day "owns" the month boundary.

**Empirical findings from 400 boundary cases (100 per calendar):**

| Calendar | Danger zone (delta) | Wrong entries | Buffer applied | Result |
|----------|-------------------|---------------|----------------|--------|
| Tamil | 0 to −7.7 min | 6 | −8.0 min from sunset | All 6 fixed |
| Bengali | Tithi-based rule | 1 (of 37 verified) | Tithi at Hindu sunrise + Karkata/Makara overrides | 36/37 correct |
| Odia | None | 0 | None needed | 100/100 correct |
| Malayalam | 0 to −9.3 min | 15 | −9.5 min from madhyahna | All 15 fixed |

The buffer is subtracted from `critical_time_jd()` in `src/solar.c`. This single change propagates through all downstream functions (rashi determination, civil day assignment, year computation).

## Known Limitations

- Default Moshier backend has 29 tithi boundary edge-case failures (99.95% pass rate) due to ~10 arcsecond lunar longitude precision. Use `make USE_SWISSEPH=1` for 100% pass rate
- Moshier backend uses analytical planetary theories (VSOP87 for Sun, ELP-2000/82 for Moon) rather than Swiss Ephemeris data files
- Amanta scheme only (no Purnimanta support)
- No nakshatra, yoga, or karana calculations
- No kshaya masa detection (extremely rare edge case)
- UTC offset is manual (no IANA timezone / DST support)
- Location defaults to New Delhi; no city database
- Solar calendars validated with 351 unit + 327 external + 28,976 regression + 1,200 edge case assertions; Tamil and Malayalam have empirical ayanamsa buffers (−8.0 and −9.5 min) to compensate for ~24 arcsecond Lahiri ayanamsa difference with drikpanchang.com
- Bengali solar calendar has 1 known edge case failure (1976-10-17 Tula sankranti) where the tithi-based rule disagrees with drikpanchang.com; 36/37 verified edge cases correct. See `Docs/BENGALI_INVESTIGATION.md`

## Dual Backend Architecture

The project supports two astronomical backends, selectable at compile time:

| Backend | Build command | Lines | Precision (solar) | Precision (lunar) | Test pass rate |
|---------|---------------|-------|--------------------|--------------------|----------------|
| **Moshier** (default) | `make` | 1,265 | ±1″ (VSOP87) | ±10″ (ELP-2000/82) | 99.95% (53,114/53,143) |
| **Swiss Ephemeris** | `make USE_SWISSEPH=1` | 51,493 | ±0.001″ | ±0.003″ | 100% (53,143/53,143) |

The Moshier library (`lib/moshier/`) implements the same 8 SE functions used by the project. See [VSOP87_IMPLEMENTATION.md](VSOP87_IMPLEMENTATION.md) for the solar longitude pipeline and precision analysis.

## Source Statistics

- Application code: ~1,550 lines across 16 files (8 .c + 8 .h)
- Moshier ephemeris library: 1,265 lines across 6 files (5 .c + 1 .h)
- Test code: ~2,140 lines across 10 files
- Vendored Swiss Ephemeris: ~51,500 lines (11 .c + 12 .h)
